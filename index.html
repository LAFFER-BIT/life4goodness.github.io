// å°è¯•è§£æJSON
            try {
                // æ¸…ç†å¯èƒ½çš„markdownæ ¼å¼
                const cleanedText = resultText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                return JSON.parse(cleanedText);
            } catch (parseError) {
                console.error('JSONè§£æå¤±è´¥:', parseError, 'åŸæ–‡:', resultText);
                throw new Error('AIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•');
            }
        }

        function displayRecognitionResult(items) {
            const resultDiv = document.getElementById('recognitionResult');
            const itemsDiv = document.getElementById('recognizedItems');
            
            itemsDiv.innerHTML = items.map(item => 
                `<span class="recognized-item">${item.name}: ${item.quantity}${item.unit}</span>`
            ).join('');
            
            resultDiv.classList.add('show');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                hideRecognitionResult();
            }, 5000);
        }

        function hideRecognitionResult() {
            document.getElementById('recognitionResult').classList.remove('show');
        }

        function addIngredientFromRecognition(item) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„é£Ÿæ
            const existingIngredient = ingredients.find(ing => 
                ing.name === item.name && ing.unit === item.unit
            );

            if (existingIngredient) {
                existingIngredient.quantity += item.quantity;
            } else {
                ingredients.push({
                    id: Date.now() + Math.random(),
                    name: item.name,
                    type: item.type || 'å…¶ä»–',
                    quantity: item.quantity,
                    unit: item.unit
                });
            }
        }

        // åŠ è½½å’Œæ˜¾ç¤ºåŠŸèƒ½
        function showLoading(text = 'å¤„ç†ä¸­...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // Service Workeræ³¨å†Œ
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', async () => {
                    try {
                        const registration = await navigator.serviceWorker.register('./sw.js');
                        console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                        
                        // ç›‘å¬æ›´æ–°
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨
                                    if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    } catch (error) {
                        console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
                    }
                });
            }
        }

        // è¯·æ±‚é€šçŸ¥æƒé™
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('é€šçŸ¥æƒé™:', permission);
                });
            }
        }

        // è·å–æ‰€æœ‰èœå“
        function getAllDishes() {
            // è¿‡æ»¤æ‰è¢«åˆ é™¤çš„ç³»ç»Ÿé¢„ç½®èœå“
            const activeDefaultDishes = defaultDishes.filter(dish => 
                !deletedDefaultDishes.includes(dish.id)
            );
            return [...activeDefaultDishes, ...customDishes];
        }

        // æŒ‰ç±»åˆ«å’Œå•ä½å¯¹é£Ÿæè¿›è¡Œåˆ†ç»„æ’åº
        function sortAndGroupIngredients(ingredients) {
            const typeOrder = { 'è”¬èœ': 1, 'è‚‰ç±»': 2, 'è°ƒæ–™': 3, 'å…¶ä»–': 4 };
            const unitOrder = { 'ä¸ª': 1, 'g': 2, 'kg': 3, 'æ ¹': 4, 'ç“£': 5, 'å—': 6, 'å‹º': 7, 'ç‰‡': 8, 'è¢‹': 9, 'ç›’': 10 };

            return ingredients.sort((a, b) => {
                const typeCompare = typeOrder[a.type] - typeOrder[b.type];
                if (typeCompare !== 0) return typeCompare;
                
                const unitCompare = unitOrder[a.unit] - unitOrder[b.unit];
                if (unitCompare !== 0) return unitCompare;
                
                return a.name.localeCompare(b.name, 'zh-CN');
            });
        }

        // è·å–åˆ†ç±»ç»Ÿè®¡
        function getCategoryStats(ingredients) {
            const stats = {};
            ingredients.forEach(ing => {
                stats[ing.type] = (stats[ing.type] || 0) + 1;
            });
            return stats;
        }

        // DOM å…ƒç´ 
        const ingredientNameInput = document.getElementById('ingredientName');
        const ingredientTypeSelect = document.getElementById('ingredientType');
        const ingredientQuantityInput = document.getElementById('ingredientQuantity');
        const ingredientUnitSelect = document.getElementById('ingredientUnit');
        const addBtn = document.getElementById('addBtn');
        const clearBtn = document.getElementById('clearBtn');
        const ingredientList = document.getElementById('ingredientList');
        const dishList = document.getElementById('dishList');
        const manageDishList = document.getElementById('manageDishList');
        const statIngredients = document.getElementById('statIngredients');
        const statAvailable = document.getElementById('statAvailable');
        const statMissing = document.getElementById('statMissing');
        const cookingHistoryList = document.getElementById('cookingHistoryList');

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'manage') {
                renderManageDishes();
            }
        }

        // æ·»åŠ é£Ÿæ
        function addIngredient() {
            const name = ingredientNameInput.value.trim();
            const type = ingredientTypeSelect.value;
            const quantity = parseFloat(ingredientQuantityInput.value);
            const unit = ingredientUnitSelect.value;

            if (name && quantity && quantity > 0) {
                ingredients.push({
                    id: Date.now(),
                    name,
                    type,
                    quantity,
                    unit
                });

                ingredientNameInput.value = '';
                ingredientQuantityInput.value = '';

                saveData();
                renderAll();
        }

        function saveEdit() {
            const name = document.getElementById('editDishName').value.trim();
            const description = document.getElementById('editDishDescription').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥èœå“åç§°');
                return;
            }

            if (tempDishIngredients.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªé£Ÿæ');
                return;
            }

            // æ£€æŸ¥èœå“åç§°æ˜¯å¦ä¸å…¶ä»–èœå“é‡å¤ï¼ˆæ’é™¤å½“å‰ç¼–è¾‘çš„èœå“ï¼‰
            const allDishes = getAllDishes();
            if (allDishes.some(dish => dish.name === name && dish.id !== currentEditingDish.id)) {
                alert('èœå“åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                return;
            }

            // åˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»Ÿé¢„ç½®èœå“
            const isDefaultDish = currentEditingDish.id && currentEditingDish.id.startsWith('default_');
            
            if (isDefaultDish) {
                // å¦‚æœæ˜¯ç³»ç»Ÿé¢„ç½®èœå“ï¼Œåˆ›å»ºæ–°çš„è‡ªå®šä¹‰èœå“å¹¶æ ‡è®°åŸèœå“ä¸ºå·²åˆ é™¤
                const newCustomDish = {
                    id: 'custom_' + Date.now(),
                    name,
                    description,
                    ingredients: [...tempDishIngredients],
                    originalId: currentEditingDish.id  // è®°å½•åŸå§‹ID
                };
                
                customDishes.push(newCustomDish);
                
                // æ ‡è®°åŸç³»ç»Ÿé¢„ç½®èœå“ä¸ºå·²åˆ é™¤
                if (!deletedDefaultDishes.includes(currentEditingDish.id)) {
                    deletedDefaultDishes.push(currentEditingDish.id);
                }
                
                saveData();
                closeEditModal();
                alert('ç³»ç»Ÿé¢„ç½®èœå“å·²è½¬æ¢ä¸ºè‡ªå®šä¹‰èœå“å¹¶ä¿å­˜æˆåŠŸï¼');
            } else {
                // å¦‚æœæ˜¯è‡ªå®šä¹‰èœå“ï¼Œç›´æ¥æ›´æ–°
                const dishIndex = customDishes.findIndex(d => d.id === currentEditingDish.id);
                if (dishIndex !== -1) {
                    customDishes[dishIndex] = {
                        ...currentEditingDish,
                        name,
                        description,
                        ingredients: [...tempDishIngredients]
                    };
                    saveData();
                    closeEditModal();
                    alert('èœå“ä¿®æ”¹æˆåŠŸï¼');
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                    return;
                }
            }
            
            renderAll();
            renderManageDishes();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditingDish = null;
            tempDishIngredients = [];
            
            // æ¸…ç©ºç¼–è¾‘è¡¨å•
            document.getElementById('editDishName').value = '';
            document.getElementById('editDishDescription').value = '';
            document.getElementById('editIngName').value = '';
            document.getElementById('editIngQuantity').value = '';
            renderEditIngredients();
        }

        // åˆ é™¤èœå“åŠŸèƒ½
        function confirmDeleteDish(dishId, dishName) {
            currentDeletingDish = dishId;
            document.getElementById('deleteDishName').textContent = dishName;
            document.getElementById('deleteModal').classList.add('active');
        }

        function deleteDish() {
            if (!currentDeletingDish) return;

            // åˆ¤æ–­æ˜¯å¦ä¸ºç³»ç»Ÿé¢„ç½®èœå“
            const isDefaultDish = currentDeletingDish.startsWith('default_');
            
            if (isDefaultDish) {
                // å¦‚æœæ˜¯ç³»ç»Ÿé¢„ç½®èœå“ï¼Œæ ‡è®°ä¸ºå·²åˆ é™¤
                if (!deletedDefaultDishes.includes(currentDeletingDish)) {
                    deletedDefaultDishes.push(currentDeletingDish);
                }
                alert('ç³»ç»Ÿé¢„ç½®èœå“åˆ é™¤æˆåŠŸï¼');
            } else {
                // å¦‚æœæ˜¯è‡ªå®šä¹‰èœå“ï¼Œä»æ•°ç»„ä¸­ç§»é™¤
                customDishes = customDishes.filter(d => d.id !== currentDeletingDish && d.name !== currentDeletingDish);
                alert('è‡ªå®šä¹‰èœå“åˆ é™¤æˆåŠŸï¼');
            }
            
            saveData();
            closeDeleteModal();
            renderAll();
            renderManageDishes();
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            currentDeletingDish = null;
        }

        // AIåŠŸèƒ½
        async function askAI() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const prompt = document.getElementById('aiPrompt').value.trim();

            if (!apiKey) {
                alert('è¯·å…ˆè¾“å…¥APIå¯†é’¥');
                return;
            }

            if (!prompt) {
                alert('è¯·è¾“å…¥ä½ çš„é—®é¢˜');
                return;
            }

            const askButton = document.getElementById('askAI');
            const aiIcon = document.getElementById('aiIcon');
            const resultDiv = document.getElementById('aiResult');

            askButton.disabled = true;
            aiIcon.innerHTML = 'â³';
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'æ­£åœ¨æ€è€ƒä¸­...';

            try {
                const ingredientsInfo = ingredients.map(ing => `${ing.name}(${ing.quantity}${ing.unit})`).join('ã€');
                const fullPrompt = `æˆ‘çš„å†°ç®±é‡Œç°æœ‰é£Ÿæï¼š${ingredientsInfo || 'æš‚æ— '}

ç”¨æˆ·é—®é¢˜ï¼š${prompt}

è¯·æ ¹æ®ç”¨æˆ·é—®é¢˜ç»™å‡ºå®ç”¨çš„èœå“å»ºè®®ï¼Œå†ç»“åˆç”¨æˆ·å·²æœ‰çš„é£Ÿæç»™åˆ°é‡‡è´­å»ºè®®ã€‚å¦‚æœæ˜¯è¯¢é—®èœå“åˆ¶ä½œæ–¹æ³•ï¼Œè¯·ç»™å‡ºè¯¦ç»†æ­¥éª¤ã€‚`;

                let response;
                if (provider === 'deepseek') {
                    response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çƒ¹é¥ªåŠ©æ‰‹ï¼Œæ“…é•¿æ ¹æ®ç”¨æˆ·é—®é¢˜æ¨èèœå“å¹¶æ ¹æ®ç”¨æˆ·å·²æœ‰é£Ÿæç»™åˆ°é‡‡è´­å»ºè®®åŒæ—¶æä¾›è¯¦ç»†çš„åˆ¶ä½œæ–¹æ³•ã€‚'
                                },
                                {
                                    role: 'user',
                                    content: fullPrompt
                                }
                            ],
                            max_tokens: 2200,
                            temperature: 0.7
                        })
                    });
                } else {
                    response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çƒ¹é¥ªåŠ©æ‰‹ï¼Œæ“…é•¿æ ¹æ®ç°æœ‰é£Ÿææ¨èèœå“å’Œæä¾›è¯¦ç»†çš„åˆ¶ä½œæ–¹æ³•ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ã€‚'
                                },
                                {
                                    role: 'user',
                                    content: fullPrompt
                                }
                            ],
                            max_tokens: 1500,
                            temperature: 0.7
                        })
                    });
                }

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;

                resultDiv.textContent = aiResponse;

                localStorage.setItem('aiApiKey', apiKey);
                localStorage.setItem('aiProvider', provider);

            } catch (error) {
                console.error('AIè¯·æ±‚å¤±è´¥:', error);
                resultDiv.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. APIæœåŠ¡æ˜¯å¦å¯ç”¨`;
            } finally {
                askButton.disabled = false;
                aiIcon.innerHTML = 'ğŸ¤–';
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('addBtn').addEventListener('click', addIngredient);
        document.getElementById('clearBtn').addEventListener('click', clearAllIngredients);
        document.getElementById('addIngredientToDish').addEventListener('click', addIngredientToDish);
        document.getElementById('saveDishBtn').addEventListener('click', saveDish);
        document.getElementById('addEditIngredient').addEventListener('click', addEditIngredient);
        document.getElementById('saveEditBtn').addEventListener('click', saveEdit);
        document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', deleteDish);
        document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);
        document.getElementById('askAI').addEventListener('click', askAI);

        // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('editModal')) {
                closeEditModal();
            }
        });

        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('deleteModal')) {
                closeDeleteModal();
            }
        });

        // å›è½¦é”®æ·»åŠ é£Ÿæ
        [ingredientNameInput, ingredientQuantityInput].forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addIngredient();
                }
            });
        });

        // æ–°èœå“é£Ÿæå›è½¦é”®
        ['newIngName', 'newIngQuantity'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addIngredientToDish();
                }
            });
        });

        // ç¼–è¾‘èœå“é£Ÿæå›è½¦é”®
        ['editIngName', 'editIngQuantity'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addEditIngredient();
                }
            });
        });

        // AIæç¤ºæ¡†å›è½¦é”®
        document.getElementById('aiPrompt').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                askAI();
            }
        });

        // åŠ è½½ä¿å­˜çš„AIè®¾ç½®
        function loadAISettings() {
            const savedApiKey = localStorage.getItem('aiApiKey');
            const savedProvider = localStorage.getItem('aiProvider');
            
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
            if (savedProvider) {
                document.getElementById('aiProvider').value = savedProvider;
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            console.log('æ™ºèƒ½å†°ç®±ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–PWAåŠŸèƒ½
            initPWA();
            registerServiceWorker();
            requestNotificationPermission();
            
            // åˆå§‹åŒ–æ‘„åƒå¤´åŠŸèƒ½
            initCamera();
            
            // åŠ è½½AIè®¾ç½®
            loadAISettings();
            
            // æ¸²æŸ“ç•Œé¢
            setTimeout(() => {
                renderAll();
                renderManageDishes();
            }, 100);

            console.log('æ™ºèƒ½å†°ç®±ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // é¡µé¢å˜ä¸ºå¯è§æ—¶åˆ·æ–°æ•°æ®
                renderAll();
            }
        });

        // å¤„ç†åœ¨çº¿/ç¦»çº¿çŠ¶æ€
        window.addEventListener('online', () => {
            console.log('ç½‘ç»œå·²è¿æ¥');
            showNotification('ç½‘ç»œçŠ¶æ€', 'å·²è¿æ¥åˆ°ç½‘ç»œ');
        });

        window.addEventListener('offline', () => {
            console.log('ç½‘ç»œå·²æ–­å¼€');
            showNotification('ç½‘ç»œçŠ¶æ€', 'ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œåº”ç”¨å°†ç»§ç»­åœ¨ç¦»çº¿æ¨¡å¼ä¸‹å·¥ä½œ');
        });

        // å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸï¼ˆç”¨äºHTMLä¸­çš„onclickï¼‰
        window.switchTab = switchTab;
        window.removeIngredient = removeIngredient;
        window.cookDish = cookDish;
        window.addMissingToShopping = addMissingToShopping;
        window.clearCookingHistory = clearCookingHistory;
        window.editDish = editDish;
        window.confirmDeleteDish = confirmDeleteDish;
        window.removeTempIngredient = removeTempIngredient;
        window.adjustIngredientQuantity = adjustIngredientQuantity;
    </script>
</body>
</html>
        }

        // åˆ é™¤é£Ÿæ
        function removeIngredient(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé£Ÿæå—ï¼Ÿ')) {
                ingredients = ingredients.filter(ing => ing.id !== id);
                saveData();
                renderAll();
            }
        }

        // æ¸…ç©ºæ‰€æœ‰é£Ÿæ
        function clearAllIngredients() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é£Ÿææ•°æ®å—ï¼Ÿ')) {
                ingredients = [];
                saveData();
                renderAll();
            }
        }

        // åˆ¶ä½œèœå“
        function cookDish(dishName) {
            const dish = getAllDishes().find(d => d.name === dishName);
            if (!dish) return;

            if (!canMakeDish(dish)) {
                alert('é£Ÿæä¸è¶³ï¼Œæ— æ³•åˆ¶ä½œæ­¤èœå“');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ¶ä½œ ${dishName} å—ï¼Ÿ\n\nå°†ä¼šè‡ªåŠ¨æ‰£å‡ä»¥ä¸‹é£Ÿæï¼š\n${dish.ingredients.map(ing => `${ing.name}: ${ing.quantity}${ing.unit}`).join('\n')}`)) {
                // æ‰£å‡é£Ÿæ
                for (const requiredIng of dish.ingredients) {
                    const availableIng = ingredients.find(ing => 
                        ing.name === requiredIng.name && ing.unit === requiredIng.unit
                    );
                    if (availableIng) {
                        availableIng.quantity -= requiredIng.quantity;
                        if (availableIng.quantity <= 0) {
                            const index = ingredients.indexOf(availableIng);
                            ingredients.splice(index, 1);
                        }
                    }
                }

                // æ·»åŠ åˆ¶ä½œè®°å½•
                const now = new Date();
                const timeString = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                cookingHistory.unshift({ dish: dishName, time: timeString, timestamp: now.getTime() });
                
                // ä¿æŒæœ€è¿‘10æ¡è®°å½•
                if (cookingHistory.length > 10) {
                    cookingHistory = cookingHistory.slice(0, 10);
                }

                saveData();
                renderAll();
                showNotification('åˆ¶ä½œå®Œæˆ', `ğŸ³ ${dishName} åˆ¶ä½œå®Œæˆï¼`);
            }
        }

        // æ·»åŠ ç¼ºå¤±é£Ÿæåˆ°é‡‡è´­æ¸…å•
        function addMissingToShopping(dishName) {
            const dish = getAllDishes().find(d => d.name === dishName);
            if (!dish) return;

            const missingIngredients = getMissingIngredients(dish);
            if (missingIngredients.length === 0) return;

            alert(`å·²å°† ${dishName} æ‰€ç¼ºé£Ÿææ·»åŠ åˆ°é‡‡è´­æé†’ï¼š\n\n${missingIngredients.map(ing => `${ing.name}: ${ing.needed}${ing.unit}`).join('\n')}`);
        }

        // æ¸…ç©ºåˆ¶ä½œå†å²
        function clearCookingHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºåˆ¶ä½œå†å²å—ï¼Ÿ')) {
                cookingHistory = [];
                saveData();
                renderCookingHistory();
            }
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ¶ä½œèœå“
        function canMakeDish(dish) {
            return dish.ingredients.every(required => {
                const available = ingredients.find(ing => 
                    ing.name === required.name && ing.unit === required.unit
                );
                return available && available.quantity >= required.quantity;
            });
        }

        // è·å–ç¼ºå°‘çš„é£Ÿæ
        function getMissingIngredients(dish) {
            return dish.ingredients.filter(required => {
                const available = ingredients.find(ing => 
                    ing.name === required.name && ing.unit === required.unit
                );
                return !available || available.quantity < required.quantity;
            }).map(missing => {
                const available = ingredients.find(ing => 
                    ing.name === missing.name && ing.unit === missing.unit
                );
                const needed = available ? 
                    missing.quantity - available.quantity : 
                    missing.quantity;
                return { ...missing, needed };
            });
        }

        // æ›´æ–°æ¨èèœå“
        function updateRecommendedDishes() {
            const allDishes = getAllDishes();
            const canMake = allDishes.filter(dish => canMakeDish(dish));
            const almostCanMake = allDishes.filter(dish => 
                !canMakeDish(dish) && 
                getMissingIngredients(dish).length <= 3
            ).map(dish => ({
                ...dish,
                missingIngredients: getMissingIngredients(dish)
            }));

            recommendedDishes = [
                ...canMake.map(dish => ({ ...dish, canMake: true })),
                ...almostCanMake.map(dish => ({ ...dish, canMake: false }))
            ];
        }

        // æ¸²æŸ“é£Ÿæåˆ—è¡¨
        function renderIngredients() {
            const ingredientListElement = document.getElementById('ingredientList');
            
            if (ingredients.length === 0) {
                ingredientListElement.innerHTML = '<div class="empty-message">æš‚æ— é£Ÿæï¼Œè¯·æ·»åŠ é£Ÿæåˆ°åº“å­˜</div>';
                clearBtn.style.display = 'none';
            } else {
                clearBtn.style.display = 'block';
                
                const sortedIngredients = sortAndGroupIngredients([...ingredients]);
                
                let currentType = '';
                let ingredientsHTML = '';
                
                sortedIngredients.forEach(ingredient => {
                    if (ingredient.type !== currentType) {
                        if (currentType !== '') {
                            ingredientsHTML += '<div style="height: 8px;"></div>';
                        }
                        currentType = ingredient.type;
                        
                        const typeIcon = {
                            'è”¬èœ': 'ğŸ¥¬',
                            'è‚‰ç±»': 'ğŸ¥©', 
                            'è°ƒæ–™': 'ğŸ§‚',
                            'å…¶ä»–': 'ğŸ“¦'
                        };
                        
                        ingredientsHTML += `
                            <div style="background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%); padding: 6px 10px; border-radius: 4px; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: #374151; border-left: 3px solid ${ingredient.type === 'è”¬èœ' ? '#22c55e' : ingredient.type === 'è‚‰ç±»' ? '#ef4444' : ingredient.type === 'è°ƒæ–™' ? '#f59e0b' : '#6b7280'};">
                                ${typeIcon[ingredient.type]} ${ingredient.type}
                            </div>
                        `;
                    }
                    
                    ingredientsHTML += `
                        <div class="ingredient-item">
                            <div class="ingredient-info">
                                <span class="ingredient-name">${ingredient.name}</span>
                                <span class="ingredient-quantity">${ingredient.quantity}${ingredient.unit}</span>
                            </div>
                            <button class="btn btn-danger" onclick="removeIngredient(${ingredient.id})">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    `;
                });
                
                ingredientListElement.innerHTML = ingredientsHTML + '<div style="height: 15px;"></div>';
            }
        }

        // æ¸²æŸ“èœå“æ¨è
        function renderDishes() {
            const allDishes = getAllDishes();
            
            if (allDishes.length === 0) {
                dishList.innerHTML = '<div class="empty-message">æš‚æ— èœå“æ•°æ®</div>';
                return;
            }

            // æŒ‰å¯åˆ¶ä½œçŠ¶æ€æ’åº
            const sortedDishes = allDishes.sort((a, b) => {
                const aCanMake = canMakeDish(a);
                const bCanMake = canMakeDish(b);
                if (aCanMake && !bCanMake) return -1;
                if (!aCanMake && bCanMake) return 1;
                return 0;
            });

            const dishesHTML = sortedDishes.map(dish => {
                const canMake = canMakeDish(dish);
                const missingIngredients = canMake ? [] : getMissingIngredients(dish);
                
                return `
                    <div class="dish-item ${canMake ? 'dish-available' : 'dish-missing'}" style="margin-bottom: 15px;">
                        <div class="dish-header">
                            <h3 class="dish-name">${dish.name}</h3>
                            <span class="dish-status ${canMake ? 'status-available' : 'status-missing'}">
                                ${canMake ? 'âœ… å¯åˆ¶ä½œ' : 'âš ï¸ ç¼ºé£Ÿæ'}
                            </span>
                        </div>
                        <div class="dish-ingredients">
                            <strong>æ‰€éœ€ï¼š</strong>
                            ${dish.ingredients.map(ing => `${ing.name}(${ing.quantity}${ing.unit})`).join('ã€')}
                        </div>
                        ${dish.description ? `<div class="dish-description">${dish.description}</div>` : ''}
                        <div class="dish-actions">
                            ${canMake ? 
                                `<button class="btn btn-cook" onclick="cookDish('${dish.name}')">ğŸ³ å®Œæˆåˆ¶ä½œ</button>` : 
                                `<button class="btn btn-shopping" onclick="addMissingToShopping('${dish.name}')">ğŸ›’ é‡‡è´­æé†’</button>`
                            }
                        </div>
                        ${!canMake && missingIngredients.length > 0 ? `
                            <div class="shopping-list">
                                <div class="shopping-title">
                                    ğŸ›’ éœ€é‡‡è´­ï¼š
                                </div>
                                <div>
                                    ${missingIngredients.map(missing => 
                                        `<span class="shopping-item">${missing.name}: ${missing.needed}${missing.unit}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            dishList.innerHTML = dishesHTML + '<div style="height: 30px;"></div>';
        }

        // æ¸²æŸ“åˆ¶ä½œå†å²
        function renderCookingHistory() {
            if (cookingHistory.length === 0) {
                cookingHistoryList.innerHTML = '<div class="empty-message" style="padding: 8px;">æš‚æ— åˆ¶ä½œè®°å½•</div>';
            } else {
                cookingHistoryList.innerHTML = cookingHistory.map(record => `
                    <div class="history-item">
                        <span class="history-dish">${record.dish}</span>
                        <span class="history-time">${record.time}</span>
                    </div>
                `).join('');
            }
        }

        // æ¸²æŸ“ç®¡ç†èœå“
        function renderManageDishes() {
            const allDishes = getAllDishes();
            const dishCount = document.getElementById('dishCount');
            
            if (dishCount) {
                dishCount.textContent = allDishes.length;
            }
            
            if (allDishes.length === 0) {
                manageDishList.innerHTML = '<div class="empty-message">æš‚æ— èœå“</div>';
            } else {
                manageDishList.innerHTML = allDishes.map(dish => {
                    const isDefault = dish.id && dish.id.startsWith('default_');
                    return `
                        <div class="dish-item" style="border-color: #e5e7eb; background: #f9fafb;">
                            <div class="dish-header">
                                <h3 class="dish-name">${dish.name}</h3>
                                <div class="dish-actions">
                                    <button class="btn btn-secondary" onclick="editDish('${dish.id || dish.name}')" title="ç¼–è¾‘èœå“">
                                        âœï¸ ç¼–è¾‘
                                    </button>
                                    <button class="btn btn-danger" onclick="confirmDeleteDish('${dish.id || dish.name}', '${dish.name}')" title="åˆ é™¤èœå“">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </div>
                            </div>
                            <div class="dish-ingredients">
                                <strong>æ‰€éœ€ï¼š</strong>
                                ${dish.ingredients.map(ing => `${ing.name}(${ing.quantity}${ing.unit})`).join('ã€')}
                            </div>
                            ${dish.description ? `<div class="dish-description">${dish.description}</div>` : ''}
                            <div class="dish-type-badge ${isDefault ? 'badge-default' : 'badge-custom'}">
                                ${isDefault ? 'ğŸ”’ ç³»ç»Ÿé¢„ç½®èœå“' : 'ğŸ”§ è‡ªå®šä¹‰èœå“'}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
        function renderStats() {
            const allDishes = getAllDishes();
            const availableDishes = allDishes.filter(dish => canMakeDish(dish));
            const missingDishes = allDishes.filter(dish => !canMakeDish(dish));
            
            statIngredients.textContent = ingredients.length;
            statAvailable.textContent = availableDishes.length;
            statMissing.textContent = missingDishes.length;
            
            const categoryStats = getCategoryStats(ingredients);
            const categoryBreakdown = document.getElementById('categoryBreakdown');
            
            if (ingredients.length === 0) {
                categoryBreakdown.innerHTML = '';
            } else {
                const categoryEmojis = {
                    'è”¬èœ': 'ğŸ¥¬',
                    'è‚‰ç±»': 'ğŸ¥©',
                    'è°ƒæ–™': 'ğŸ§‚', 
                    'å…¶ä»–': 'ğŸ“¦'
                };
                
                const breakdownText = Object.entries(categoryStats)
                    .map(([type, count]) => `${categoryEmojis[type]}${count}`)
                    .join(' ');
                    
                categoryBreakdown.innerHTML = breakdownText;
            }
        }

        // æ¸²æŸ“æ‰€æœ‰å†…å®¹
        function renderAll() {
            updateRecommendedDishes();
            renderIngredients();
            renderDishes();
            renderStats();
            renderCookingHistory();
        }

        // ä¿å­˜æ•°æ®åˆ°localStorage
        function saveData() {
            localStorage.setItem('fridgeIngredients', JSON.stringify(ingredients));
            localStorage.setItem('customDishes', JSON.stringify(customDishes));
            localStorage.setItem('cookingHistory', JSON.stringify(cookingHistory));
            localStorage.setItem('deletedDefaultDishes', JSON.stringify(deletedDefaultDishes));
        }

        // èœå“ç®¡ç†åŠŸèƒ½
        function addIngredientToDish() {
            const name = document.getElementById('newIngName').value.trim();
            const quantity = parseFloat(document.getElementById('newIngQuantity').value);
            const unit = document.getElementById('newIngUnit').value;

            if (name && quantity && quantity > 0) {
                tempDishIngredients.push({ name, quantity, unit });
                document.getElementById('newIngName').value = '';
                document.getElementById('newIngQuantity').value = '';
                renderTempIngredients();
            } else {
                alert('è¯·å¡«å†™å®Œæ•´çš„é£Ÿæä¿¡æ¯');
            }
        }

        function renderTempIngredients() {
            const container = document.getElementById('dishIngredientsList');
            if (tempDishIngredients.length === 0) {
                container.innerHTML = '<div class="empty-message" style="padding: 10px; font-size: 0.8rem;">æš‚æ— é£Ÿæï¼Œè¯·æ·»åŠ é£Ÿæ</div>';
            } else {
                container.innerHTML = tempDishIngredients.map((ing, index) => `
                    <div class="ingredient-item" style="margin-bottom: 5px; padding: 10px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <div style="flex: 1; min-width: 0;">
                                <span style="font-weight: 500;">${ing.name}</span>
                                <span style="color: #6b7280; margin-left: 8px;">${ing.quantity}${ing.unit}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
                                <button class="btn btn-secondary" onclick="adjustIngredientQuantity(${index}, -0.5)" title="å‡å°‘æ•°é‡" style="padding: 2px 6px; font-size: 0.7rem;">
                                    âˆ’
                                </button>
                                <button class="btn btn-primary" onclick="adjustIngredientQuantity(${index}, 0.5)" title="å¢åŠ æ•°é‡" style="padding: 2px 6px; font-size: 0.7rem;">
                                    +
                                </button>
                                <button class="btn btn-danger" onclick="removeTempIngredient(${index})" title="åˆ é™¤é£Ÿæ" style="padding: 2px 6px; font-size: 0.7rem;">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function removeTempIngredient(index) {
            tempDishIngredients.splice(index, 1);
            renderTempIngredients();
            if (currentEditingDish) {
                renderEditIngredients();
            }
        }

        // è°ƒæ•´é£Ÿææ•°é‡
        function adjustIngredientQuantity(index, change) {
            if (index >= 0 && index < tempDishIngredients.length) {
                const ingredient = tempDishIngredients[index];
                const newQuantity = ingredient.quantity + change;
                
                // ç¡®ä¿æ•°é‡ä¸å°äº0.5
                if (newQuantity >= 0.5) {
                    ingredient.quantity = Math.round(newQuantity * 10) / 10; // ä¿ç•™ä¸€ä½å°æ•°
                    
                    // é‡æ–°æ¸²æŸ“
                    if (currentEditingDish) {
                        renderEditIngredients();
                    } else {
                        renderTempIngredients();
                    }
                } else {
                    // å¦‚æœæ•°é‡è¦å°äº0.5ï¼Œè¯¢é—®æ˜¯å¦åˆ é™¤
                    if (confirm(`${ingredient.name} çš„æ•°é‡å°†å˜ä¸º ${newQuantity}${ingredient.unit}ï¼Œè¿™ä¸ªæ•°é‡å¤ªå°‘äº†ã€‚æ˜¯å¦è¦åˆ é™¤è¿™ä¸ªé£Ÿæï¼Ÿ`)) {
                        removeTempIngredient(index);
                    }
                }
            }
        }

        function saveDish() {
            const name = document.getElementById('newDishName').value.trim();
            const description = document.getElementById('newDishDescription').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥èœå“åç§°');
                return;
            }

            if (tempDishIngredients.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªé£Ÿæ');
                return;
            }

            // æ£€æŸ¥èœå“åç§°æ˜¯å¦å·²å­˜åœ¨
            const allDishes = getAllDishes();
            if (allDishes.some(dish => dish.name === name)) {
                alert('èœå“åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                return;
            }

            const newDish = {
                id: 'custom_' + Date.now(),
                name,
                description,
                ingredients: [...tempDishIngredients]
            };

            customDishes.push(newDish);
            saveData();

            // æ¸…ç©ºè¡¨å•
            document.getElementById('newDishName').value = '';
            document.getElementById('newDishDescription').value = '';
            tempDishIngredients = [];
            renderTempIngredients();

            alert('èœå“æ·»åŠ æˆåŠŸï¼');
            renderAll();
            renderManageDishes();
        }

        // ç¼–è¾‘èœå“åŠŸèƒ½
        function editDish(dishId) {
            // å…ˆåœ¨è‡ªå®šä¹‰èœå“ä¸­æŸ¥æ‰¾
            let dish = customDishes.find(d => d.id === dishId || d.name === dishId);
            
            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåœ¨ç³»ç»Ÿé¢„ç½®èœå“ä¸­æŸ¥æ‰¾
            if (!dish) {
                dish = defaultDishes.find(d => d.id === dishId || d.name === dishId);
            }
            
            if (!dish) {
                alert('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„èœå“');
                return;
            }

            currentEditingDish = dish;
            tempDishIngredients = [...dish.ingredients];

            document.getElementById('editDishName').value = dish.name;
            document.getElementById('editDishDescription').value = dish.description || '';
            renderEditIngredients();

            document.getElementById('editModal').classList.add('active');
        }

        function renderEditIngredients() {
            const container = document.getElementById('editIngredientsList');
            if (tempDishIngredients.length === 0) {
                container.innerHTML = '<div class="empty-message" style="padding: 10px; font-size: 0.8rem;">æš‚æ— é£Ÿæï¼Œè¯·æ·»åŠ é£Ÿæ</div>';
            } else {
                container.innerHTML = tempDishIngredients.map((ing, index) => `
                    <div class="ingredient-item" style="margin-bottom: 5px; padding: 10px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <div style="flex: 1; min-width: 0;">
                                <span style="font-weight: 500;">${ing.name}</span>
                                <span style="color: #6b7280; margin-left: 8px;">${ing.quantity}${ing.unit}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
                                <button class="btn btn-secondary" onclick="adjustIngredientQuantity(${index}, -0.5)" title="å‡å°‘æ•°é‡" style="padding: 2px 6px; font-size: 0.7rem;">
                                    âˆ’
                                </button>
                                <button class="btn btn-primary" onclick="adjustIngredientQuantity(${index}, 0.5)" title="å¢åŠ æ•°é‡" style="padding: 2px 6px; font-size: 0.7rem;">
                                    +
                                </button>
                                <button class="btn btn-danger" onclick="removeTempIngredient(${index})" title="åˆ é™¤é£Ÿæ" style="padding: 2px 6px; font-size: 0.7rem;">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function addEditIngredient() {
            const name = document.getElementById('editIngName').value.trim();
            const quantity = parseFloat(document.getElementById('editIngQuantity').value);
            const unit = document.getElementById('editIngUnit').value;

            if (name && quantity && quantity > 0) {
                tempDishIngredients.push({ name, quantity, unit });
                document.getElementById('editIngName').value = '';
                document.getElementById('editIngQuantity').value = '';
                renderEditIngredients();
            } else {
                alert('è¯·å¡«å†™å®Œæ•´çš„é£Ÿæä¿¡æ¯');
            }    <script>
        // åº”ç”¨çŠ¶æ€
        let ingredients = JSON.parse(localStorage.getItem('fridgeIngredients') || '[]');
        let customDishes = JSON.parse(localStorage.getItem('customDishes') || '[]');
        let cookingHistory = JSON.parse(localStorage.getItem('cookingHistory') || '[]');
        let deletedDefaultDishes = JSON.parse(localStorage.getItem('deletedDefaultDishes') || '[]');
        let recommendedDishes = [];
        let currentEditingDish = null;
        let currentDeletingDish = null;
        let tempDishIngredients = [];

        // PWAç›¸å…³å˜é‡
        let deferredPrompt;
        let isInstalled = false;

        // é¢„å®šä¹‰çš„èœå“æ•°æ®åº“
        const defaultDishes = [
            {
                id: 'default_1',
                name: 'è‘±æ²¹ç„–é¸¡',
                description: '1. é¸¡å—æå‰è…Œåˆ¶ï¼Œçƒ­é”…ä¸‹æ²¹åŠ å…¥è‘±å§œç…å‡ºè‘±æ²¹\n2. å€’å…¥é¸¡å—ç¿»ç‚’\n3. åŠ å…¥è°ƒç†å§œç‰‡ç¿»ç‚’å‡åŒ€å‡ºé”…',
                ingredients: [
                    { name: 'é¸¡å—', quantity: 1, unit: 'ä»½' },
                    { name: 'å§œ', quantity: 0.5, unit: 'ä¸ª' },
                    { name: 'è‘±', quantity: 1, unit: 'æ ¹' }
                ]
            },
            {
                id: 'default_2',
                name: 'ç§‹è‘µç‚’ç´ è‚ ',
                description: '1. ç§‹è‘µåˆ‡ç‰‡æ¸…æ´—\n2. ç´ è‚ åˆ‡ç‰‡\n3. çƒ­é”…ç‚’é’æ¤’è‡³å˜è‰²\n4. åŠ ç§‹è‘µç´ è‚ ç‚’åŒ€å‡ºåº“',
                ingredients: [
                    { name: 'ç§‹è‘µ', quantity: 1, unit: 'ä»½' },
                    { name: 'é’æ¤’', quantity: 1, unit: 'ä¸ª' },
                    { name: 'ç´ è‚ ', quantity: 0.5, unit: 'ä»½' }
                ]
            },
            {
                id: 'default_3',
                name: 'å¹²é”…èŠ±èœ',
                description: '1. èŠ±èœåˆ‡å°æœµï¼Œä¸‹é”…ç„¯æ°´\n2. çƒ­é”…ä¸‹æ²¹ï¼ŒåŠ å…¥è¾£æ¤’èŠ±æ¤’èŠ±èœç¿»ç‚’\n3. åŠ å…¥è°ƒæ–™ç‚’åŒ€å³å¯',
                ingredients: [
                    { name: 'èŠ±èœ', quantity: 1, unit: 'æ£µ' },
                    { name: 'è¾£æ¤’', quantity: 0.5, unit: 'ä»½' },
                    { name: 'èŠ±æ¤’', quantity: 1, unit: 'ä»½' }
                ]
            },
            {
                id: 'default_4',
                name: 'é»„ç„–é¸¡',
                description: '1. çƒ­é”…ä¸‹è‘±å§œè’œç‚’é¦™\n2. å€’å…¥é¸¡å—ç‚’è‡³å¾®é»„\n3. å€’å…¥é…±æ±å¹¶åŠ å…¥å¼€æ°´æ¼«è¿‡é¸¡è‚‰\n4. å€’å…¥åœŸè±†é¦™è‡ç­‰é…æ–™ç„–ç…®30åˆ†é’Ÿ\n5. æ±¤æ±æ”¶æµ“åŠ å…¥é’çº¢è¾£æ¤’æ´‹è‘±å†ç…®5åˆ†é’Ÿå³å¯å‡ºé”…',
                ingredients: [
                    { name: 'é¸¡å—', quantity: 1, unit: 'ä»½' },
                    { name: 'é¦™è‡', quantity: 0.5, unit: 'ä»½' },    
                    { name: 'åœŸè±†', quantity: 1, unit: 'ä¸ª' },
                    { name: 'é’çº¢è¾£æ¤’', quantity: 0.5, unit: 'ä»½' },
                    { name: 'æ´‹è‘±', quantity: 1, unit: 'ä¸ª' },
                    { name: 'å§œ', quantity: 0.5, unit: 'ä¸ª' },
                    { name: 'è‘±', quantity: 1, unit: 'æ ¹' }
                ]
            },
            {
                id: 'default_5',
                name: 'çƒ¤é¸¡è…¿',
                description: '1. é¸¡è…¿æå‰è…Œåˆ¶æˆ–è€…ä½¿ç”¨é¢„åˆ¶é¸¡è…¿\n2. çƒ¤ç®±é¢„çƒ­\n3. æ”¾å…¥é¸¡è…¿çƒ¤åˆ¶18åˆ†é’Ÿå‡ºç‚‰',
                ingredients: [
                    { name: 'é¸¡è…¿', quantity: 3, unit: 'æ ¹' }
                ]
            }
        ];

        // PWAå®‰è£…åŠŸèƒ½
        function initPWA() {
            // æ£€æµ‹æ˜¯å¦å·²å®‰è£…
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                isInstalled = true;
                document.getElementById('installPrompt').style.display = 'none';
            }

            // ç›‘å¬beforeinstallpromptäº‹ä»¶
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('PWA: beforeinstallpromptäº‹ä»¶è§¦å‘');
                e.preventDefault();
                deferredPrompt = e;
                showInstallPrompt();
            });

            // ç›‘å¬appinstalledäº‹ä»¶
            window.addEventListener('appinstalled', (e) => {
                console.log('PWA: åº”ç”¨å·²å®‰è£…');
                isInstalled = true;
                hideInstallPrompt();
                showNotification('åº”ç”¨å®‰è£…æˆåŠŸï¼', 'æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å†°ç®±ç®¡ç†ç³»ç»Ÿ');
            });

            // å®‰è£…æŒ‰é’®äº‹ä»¶
            document.getElementById('installBtn').addEventListener('click', installApp);
            document.getElementById('dismissBtn').addEventListener('click', hideInstallPrompt);
        }

        function showInstallPrompt() {
            if (!isInstalled && deferredPrompt) {
                const prompt = document.getElementById('installPrompt');
                prompt.classList.add('show');
            }
        }

        function hideInstallPrompt() {
            const prompt = document.getElementById('installPrompt');
            prompt.classList.remove('show');
        }

        async function installApp() {
            if (!deferredPrompt) {
                console.log('PWA: æ²¡æœ‰å¯ç”¨çš„å®‰è£…æç¤º');
                return;
            }

            const result = await deferredPrompt.prompt();
            console.log('PWA: å®‰è£…æç¤ºç»“æœ:', result);
            
            deferredPrompt = null;
            hideInstallPrompt();
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body, icon: './icons/icon-192x192.png' });
            }
        }

        // å›¾ç‰‡è¯†åˆ«åŠŸèƒ½
        function initCamera() {
            const cameraBtn = document.getElementById('cameraBtn');
            const cameraInput = document.getElementById('cameraInput');

            cameraBtn.addEventListener('click', () => {
                cameraInput.click();
            });

            cameraInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await processImage(file);
                }
            });
        }

        async function processImage(file) {
            showLoading('æ­£åœ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„é£Ÿæ...');
            
            try {
                const base64 = await fileToBase64(file);
                const recognizedItems = await recognizeIngredients(base64);
                
                if (recognizedItems && recognizedItems.length > 0) {
                    displayRecognitionResult(recognizedItems);
                    
                    // è¯¢é—®æ˜¯å¦æ·»åŠ è¯†åˆ«åˆ°çš„é£Ÿæ
                    const confirmed = confirm(`è¯†åˆ«åˆ° ${recognizedItems.length} ç§é£Ÿæï¼Œæ˜¯å¦æ·»åŠ åˆ°åº“å­˜ï¼Ÿ\n\n${recognizedItems.map(item => `${item.name}: ${item.quantity}${item.unit}`).join('\n')}`);
                    
                    if (confirmed) {
                        recognizedItems.forEach(item => {
                            addIngredientFromRecognition(item);
                        });
                        hideRecognitionResult();
                        renderAll();
                        showNotification('è¯†åˆ«æˆåŠŸ', `å·²æ·»åŠ  ${recognizedItems.length} ç§é£Ÿæåˆ°åº“å­˜`);
                    }
                } else {
                    alert('æœªèƒ½è¯†åˆ«åˆ°é£Ÿæï¼Œè¯·å°è¯•é‡æ–°æ‹ç…§æˆ–æ‰‹åŠ¨æ·»åŠ ');
                }
            } catch (error) {
                console.error('å›¾ç‰‡è¯†åˆ«å¤±è´¥:', error);
                alert('å›¾ç‰‡è¯†åˆ«å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                reader.readAsDataURL(file);
            });
        }

        async function recognizeIngredients(base64Image) {
            const apiKey = document.getElementById('apiKey').value.trim();
            const provider = document.getElementById('aiProvider').value;
            
            if (!apiKey) {
                throw new Error('è¯·å…ˆåœ¨AIåŠ©æ‰‹é¡µé¢é…ç½®APIå¯†é’¥');
            }

            const prompt = `è¯·è¯†åˆ«è¿™å¼ å›¾ç‰‡ä¸­çš„é£Ÿæã€‚ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ï¼š
[{"name": "é£Ÿæåç§°", "quantity": æ•°é‡, "unit": "å•ä½", "type": "ç±»åˆ«"}]

è¦æ±‚ï¼š
1. quantityå¿…é¡»æ˜¯æ•°å­—
2. unitåªèƒ½æ˜¯: ä¸ªã€æ ¹ã€ç‰‡ã€è¢‹ã€ç›’ã€ä»½ã€gã€é¢—ã€å—ä¸­çš„ä¸€ä¸ª
3. typeåªèƒ½æ˜¯: è”¬èœã€è‚‰ç±»ã€è°ƒæ–™ã€å…¶ä»–ä¸­çš„ä¸€ä¸ª
4. å¦‚æœæ— æ³•ç¡®å®šæ•°é‡ï¼Œé»˜è®¤è®¾ä¸º1
5. åªè¿”å›JSONæ•°ç»„ï¼Œä¸è¦ä»»ä½•è§£é‡Šæ–‡å­—`;

            let response;
            if (provider === 'deepseek') {
                response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    { type: 'text', text: prompt },
                                    { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64Image}` } }
                                ]
                            }
                        ],
                        max_tokens: 1000
                    })
                });
            } else {
                response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-vision-preview',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    { type: 'text', text: prompt },
                                    { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64Image}` } }
                                ]
                            }
                        ],
                        max_tokens: 1000
                    })
                });
            }

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
            }

            const data = await response.json();
            const resultText = data.choices[0].message.content.trim();
            
            // å°è¯•è§£æJSON
            try {
                // æ¸…ç†å¯èƒ½çš„markdownæ ¼å¼
                const cleanedText = resultText.replace(/```json\n?/g,<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å†°ç®±ç®¡ç†ç³»ç»Ÿ</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="æ™ºèƒ½å†°ç®±">
    <meta name="description" content="ç®¡ç†æ‚¨çš„é£Ÿæåº“å­˜ï¼Œè·å–æ™ºèƒ½èœå“æ¨èå’ŒAIçƒ¹é¥ªå»ºè®®">
    
    <!-- Apple Touch Icons (ä½¿ç”¨å†…è”SVGå›¾æ ‡) -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiMzYjgyZjYiLz4KPHRleHQgeD0iOTAiIHk9IjEwNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjcwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+OiDwvdGV4dD4KPC9zdmc+">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px 0;
        }

        .header h1 {
            color: #1f2937;
            font-size: 1.8rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .header p {
            color: #6b7280;
            font-size: 0.85rem;
        }

        /* PWAå®‰è£…æç¤ºæ ·å¼ */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        .install-prompt.show {
            display: flex;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .install-prompt .install-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .install-prompt .install-content {
            flex: 1;
        }

        .install-prompt .install-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .install-prompt .install-text {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .install-prompt .install-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .install-prompt button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .install-prompt .btn-install {
            background: white;
            color: #3b82f6;
        }

        .install-prompt .btn-install:hover {
            background: #f3f4f6;
        }

        .install-prompt .btn-dismiss {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .install-prompt .btn-dismiss:hover {
            background: rgba(255,255,255,0.3);
        }

        /* æ‘„åƒå¤´æŒ‰é’®æ ·å¼ */
        .camera-section {
            margin-bottom: 15px;
        }

        .camera-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .camera-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .camera-btn:active {
            transform: translateY(0);
        }

        .camera-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .camera-input {
            display: none;
        }

        /* å›¾ç‰‡è¯†åˆ«ç»“æœæ ·å¼ */
        .recognition-result {
            background: #f0fdf4;
            border: 2px solid #bbf7d0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            display: none;
        }

        .recognition-result.show {
            display: block;
        }

        .recognition-result h4 {
            color: #059669;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .recognized-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .recognized-item {
            background: #dcfce7;
            color: #166534;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid #bbf7d0;
        }

        /* åŠ è½½çŠ¶æ€æ ·å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 280px;
            width: 90%;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #374151;
            font-weight: 500;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .install-prompt {
                bottom: 10px;
                left: 10px;
                right: 10px;
                padding: 12px;
            }

            .install-prompt .install-buttons {
                flex-direction: column;
                gap: 6px;
            }

            .install-prompt button {
                padding: 10px;
                width: 100%;
            }
        }

        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: #3b82f6;
            color: white;
        }

        .tab-content {
            display: none;
            min-height: calc(100vh - 160px);
        }

        .tab-content.active {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            min-height: calc(100vh - 180px);
        }

        @media (min-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr 2fr;
            }
        }

        @media (min-width: 1200px) {
            .main-grid {
                grid-template-columns: 350px 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            padding: 16px;
            height: fit-content;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-group {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 6px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
        }

        .input, .select, .textarea {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.8rem;
            width: 100%;
        }

        .textarea {
            resize: vertical;
            min-height: 60px;
        }

        .input:focus, .select:focus, .textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            transition: all 0.2s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4b5563;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #047857;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-clear {
            background: transparent;
            color: #ef4444;
            border: 1px solid #ef4444;
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        .btn-cook {
            background: #10b981;
            color: white;
            font-size: 0.75rem;
            padding: 6px 12px;
        }

        .btn-cook:hover:not(:disabled) {
            background: #059669;
        }

        .btn-shopping {
            background: #f59e0b;
            color: white;
            font-size: 0.75rem;
            padding: 6px 12px;
        }

        .btn-shopping:hover:not(:disabled) {
            background: #d97706;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 4px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .ingredient-item:hover {
            background: #f8fafc;
            border-color: #3b82f6;
        }

        .dish-item {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 6px;
            border: 2px solid;
            flex-direction: column;
        }

        .dish-available {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .dish-missing {
            background: #fff7ed;
            border-color: #fed7aa;
        }

        .ingredient-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .ingredient-name {
            font-weight: 500;
            flex-shrink: 0;
        }

        .ingredient-quantity {
            color: #6b7280;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .dish-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .dish-name {
            font-weight: 600;
            font-size: 1rem;
            flex: 1;
        }

        .dish-status {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            margin-left: 8px;
        }

        .status-available {
            background: #dcfce7;
            color: #166534;
        }

        .status-missing {
            background: #fed7aa;
            color: #9a3412;
        }

        .dish-ingredients {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .dish-description {
            font-size: 0.875rem;
            color: #374151;
            background: #f8fafc;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            border-left: 3px solid #3b82f6;
            white-space: pre-line;
        }

        .dish-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .shopping-list {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #fed7aa;
            margin-top: 8px;
        }

        .shopping-title {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            color: #9a3412;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .shopping-item {
            display: inline-block;
            background: #fed7aa;
            color: #9a3412;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 0.75rem;
        }

        .ai-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 15px;
            min-height: calc(100vh - 200px);
        }

        .ai-config {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .ai-config label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .ai-config .input, .ai-config .select {
            background: rgba(255, 255, 255, 0.9);
            color: #1f2937;
        }

        .ai-result {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: calc(100vh - 400px);
            overflow-y: auto;
            min-height: 200px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .empty-message {
            text-align: center;
            color: #6b7280;
            padding: 15px;
            font-size: 0.8rem;
        }

        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: #f0f9ff;
            border-radius: 4px;
            margin-bottom: 4px;
            border-left: 3px solid #3b82f6;
            font-size: 0.85rem;
        }

        .history-dish {
            font-weight: 500;
            color: #1f2937;
        }

        .history-time {
            color: #6b7280;
            font-size: 0.75rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dish-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-top: 8px;
        }

        .badge-default {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge-custom {
            background: #fef3c7;
            color: #92400e;
        }

        @media (max-width: 767px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .ingredient-item {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .dish-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- PWAå®‰è£…æç¤º -->
    <div id="installPrompt" class="install-prompt">
        <div class="install-icon">ğŸ“±</div>
        <div class="install-content">
            <div class="install-title">å®‰è£…åˆ°æ¡Œé¢</div>
            <div class="install-text">æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œè·å¾—æ›´å¥½çš„ä½¿ç”¨ä½“éªŒ</div>
        </div>
        <div class="install-buttons">
            <button id="installBtn" class="btn-install">å®‰è£…</button>
            <button id="dismissBtn" class="btn-dismiss">ç¨å</button>
        </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div id="loadingText" class="loading-text">å¤„ç†ä¸­...</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>
                ğŸ§Š æ™ºèƒ½å†°ç®±ç®¡ç†ç³»ç»Ÿ
            </h1>
            <p>ç®¡ç†æ‚¨çš„é£Ÿæåº“å­˜ï¼Œè·å–æ™ºèƒ½èœå“æ¨èå’ŒAIçƒ¹é¥ªå»ºè®®</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('ingredients')">ğŸ¥¬ é£Ÿæç®¡ç†</button>
            <button class="tab-button" onclick="switchTab('manage')">ğŸ“‹ èœå“åº“ç®¡ç†</button>
            <button class="tab-button" onclick="switchTab('ai')">ğŸ¤– AIåŠ©æ‰‹</button>
        </div>

        <!-- é£Ÿæç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="ingredients-tab" class="tab-content active">
            <div class="main-grid" style="height: calc(100vh - 160px);">
                <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h2 class="card-title">
                            â• é£Ÿæåº“å­˜ç®¡ç†
                        </h2>
                        <button id="clearBtn" class="btn btn-clear" style="display: none;">æ¸…ç©º</button>
                    </div>

                    <!-- æ‘„åƒå¤´åŠŸèƒ½åŒº -->
                    <div class="camera-section">
                        <button id="cameraBtn" class="camera-btn">
                            ğŸ“· æ‹ç…§è¯†åˆ«é£Ÿæ
                        </button>
                        <input type="file" id="cameraInput" class="camera-input" accept="image/*" capture="camera">
                    </div>

                    <!-- å›¾ç‰‡è¯†åˆ«ç»“æœ -->
                    <div id="recognitionResult" class="recognition-result">
                        <h4>ğŸ¯ è¯†åˆ«ç»“æœ</h4>
                        <div id="recognizedItems" class="recognized-items"></div>
                    </div>

                    <div class="form-group" style="flex-shrink: 0;">
                        <div class="form-row">
                            <input type="text" id="ingredientName" class="input" placeholder="é£Ÿæåç§°">
                            <select id="ingredientType" class="select">
                                <option value="è”¬èœ">è”¬èœ</option>
                                <option value="è‚‰ç±»">è‚‰ç±»</option>
                                <option value="è°ƒæ–™">è°ƒæ–™</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="form-row-3">
                            <input type="number" id="ingredientQuantity" class="input" placeholder="æ•°é‡">
                            <select id="ingredientUnit" class="select">
                                <option value="ä»½">ä»½</option>
                                <option value="è¢‹">è¢‹</option>
                                <option value="ç›’">ç›’</option>
                                <option value="ä¸ª">ä¸ª</option>
                                <option value="é¢—">é¢—</option>
                                <option value="g">g</option>
                                <option value="å—">å—</option>
                                <option value="æ ¹">æ ¹</option>
                                <option value="ç‰‡">ç‰‡</option>
                            </select>
                            <button id="addBtn" class="btn btn-primary">
                                â• æ·»åŠ 
                            </button>
                        </div>
                    </div>

                    <div id="ingredientList" style="flex: 1; overflow-y: auto; background: #fafafa; border-radius: 6px; padding: 8px; border: 1px solid #e5e7eb; margin-bottom: 10px; max-height: 280px;">
                        <div class="empty-message">æš‚æ— é£Ÿæï¼Œè¯·æ·»åŠ é£Ÿæåˆ°åº“å­˜</div>
                    </div>

                    <div class="stats" style="margin-top: 0; flex-shrink: 0;">
                        <div class="stat-card">
                            <div id="statIngredients" class="stat-number" style="color: #3b82f6;">0</div>
                            <div class="stat-label">åº“å­˜æ€»æ•°</div>
                            <div id="categoryBreakdown" style="font-size: 0.7rem; color: #6b7280; margin-top: 4px;"></div>
                        </div>
                        <div class="stat-card">
                            <div id="statAvailable" class="stat-number" style="color: #059669;">0</div>
                            <div class="stat-label">å¯åˆ¶ä½œ</div>
                        </div>
                        <div class="stat-card">
                            <div id="statMissing" class="stat-number" style="color: #d97706;">0</div>
                            <div class="stat-label">éœ€è¡¥å……</div>
                        </div>
                    </div>

                    <!-- åˆ¶ä½œå†å² -->
                    <div id="cookingHistorySection" style="margin-top: 10px; flex-shrink: 0;">
                        <h3 style="font-size: 0.9rem; color: #374151; margin-bottom: 8px; display: flex; align-items: center; gap: 4px;">
                            ğŸ“‹ åˆ¶ä½œå†å²
                            <button id="clearHistoryBtn" class="btn btn-clear" style="font-size: 0.7rem; padding: 2px 6px; margin-left: auto;" onclick="clearCookingHistory()">æ¸…ç©º</button>
                        </h3>
                        <div id="cookingHistoryList" style="max-height: 120px; overflow-y: auto; background: #f8fafc; border-radius: 4px; padding: 8px; border: 1px solid #e5e7eb;">
                            <div class="empty-message" style="padding: 8px;">æš‚æ— åˆ¶ä½œè®°å½•</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                    <h2 class="card-title" style="flex-shrink: 0;">
                        ğŸ‘¨â€ğŸ³ æ™ºèƒ½èœå“æ¨èï¼ˆå…¨éƒ¨èœå“ï¼‰
                    </h2>

                    <div id="dishList" style="flex: 1; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; background: #fafafa;">
                        <div class="empty-message">æ­£åœ¨åŠ è½½èœå“...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- èœå“åº“ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="manage-tab" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            ğŸ“– æ·»åŠ æ–°èœå“
                        </h2>
                    </div>

                    <div class="form-group">
                        <input type="text" id="newDishName" class="input" placeholder="èœå“åç§°" style="margin-bottom: 8px;">
                        <textarea id="newDishDescription" class="textarea" placeholder="åˆ¶ä½œæ–¹æ³•æˆ–æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>

                    <div id="newDishIngredients">
                        <h3 style="margin-bottom: 10px; font-size: 0.95rem;">æ‰€éœ€é£Ÿæ</h3>
                        <div class="form-row-3" style="margin-bottom: 8px;">
                            <input type="text" id="newIngName" class="input" placeholder="é£Ÿæåç§°">
                            <input type="number" id="newIngQuantity" class="input" placeholder="æ•°é‡">
                            <select id="newIngUnit" class="select">
                                <option value="ä»½">ä»½</option>
                                <option value="è¢‹">è¢‹</option>
                                <option value="ç›’">ç›’</option>
                                <option value="ä¸ª">ä¸ª</option>
                                <option value="é¢—">é¢—</option>
                                <option value="g">g</option>
                                <option value="å—">å—</option>
                                <option value="æ ¹">æ ¹</option>
                                <option value="ç‰‡">ç‰‡</option>
                            </select>
                        </div>
                        <button id="addIngredientToDish" class="btn btn-secondary" style="margin-bottom: 10px;">
                            â• æ·»åŠ é£Ÿæ
                        </button>
                        <div id="dishIngredientsList"></div>
                    </div>

                    <button id="saveDishBtn" class="btn btn-success">
                        ğŸ’¾ ä¿å­˜èœå“
                    </button>
                </div>

                <div class="card" style="height: calc(100vh - 160px);">
                    <div class="card-header">
                        <h2 class="card-title">
                            âœï¸ ç®¡ç†èœå“åº“
                        </h2>
                        <div style="font-size: 0.75rem; color: #6b7280;">
                            å…± <span id="dishCount">0</span> ä¸ªèœå“
                        </div>
                    </div>
                    <div id="manageDishList" style="max-height: calc(100vh - 220px); overflow-y: auto;">
                        <div class="empty-message">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AIåŠ©æ‰‹æ ‡ç­¾é¡µ -->
        <div id="ai-tab" class="tab-content">
            <div class="ai-section">
                <h2 style="margin-bottom: 20px;">
                    ğŸ¤– AIçƒ¹é¥ªåŠ©æ‰‹
                </h2>

                <div class="ai-config">
                    <label>é€‰æ‹©AIæœåŠ¡ï¼š</label>
                    <select id="aiProvider" class="select" style="margin-bottom: 10px;">
                        <option value="deepseek">DeepSeekï¼ˆæ¨èï¼‰</option>
                        <option value="openai">OpenAI ChatGPT</option>
                    </select>

                    <label>APIå¯†é’¥ï¼š</label>
                    <input type="password" id="apiKey" class="input" placeholder="è¯·è¾“å…¥ä½ çš„APIå¯†é’¥" style="margin-bottom: 10px;">
                    
                    <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 10px;">
                        ğŸ’¡ DeepSeek APIæ›´ä¾¿å®œï¼ŒChatGPTæ›´æ™ºèƒ½ã€‚å¯†é’¥ä»…æœ¬åœ°å­˜å‚¨ï¼Œä¸ä¼šä¸Šä¼ ã€‚
                    </div>
                </div>

                <div class="form-group" style="background: rgba(255,255,255,0.1);">
                    <textarea id="aiPrompt" class="textarea" placeholder="å‘AIæè¿°ä½ çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼š
- æ ¹æ®æˆ‘ç°æœ‰çš„é£Ÿææ¨èå‡ é“èœ
- è¯¦ç»†ä»‹ç»èœå“çš„åšæ³•
- æ¨èä¸€äº›é€‚åˆå‡è‚¥çš„èœå“
- è¿™äº›é£Ÿææ­é…æœ‰ä»€ä¹ˆè¥å…»ä»·å€¼" style="min-height: 100px; background: rgba(255,255,255,0.9); color: #1f2937;"></textarea>
                    
                    <button id="askAI" class="btn btn-success" style="margin-top: 10px;">
                        <span id="aiIcon">ğŸ¤–</span>
                        è¯¢é—®AIåŠ©æ‰‹
                    </button>
                </div>

                <div id="aiResult" class="ai-result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘èœå“æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px; color: #1f2937; font-weight: 600;">ç¼–è¾‘èœå“</h3>
            <input type="text" id="editDishName" class="input" placeholder="èœå“åç§°" style="margin-bottom: 8px;">
            <textarea id="editDishDescription" class="textarea" placeholder="åˆ¶ä½œæ–¹æ³•æˆ–æè¿°"></textarea>
            
            <div style="margin: 15px 0;">
                <h4 style="margin-bottom: 10px; color: #374151;">æ‰€éœ€é£Ÿæ</h4>
                <div class="form-row-3" style="margin-bottom: 8px;">
                    <input type="text" id="editIngName" class="input" placeholder="é£Ÿæåç§°">
                    <input type="number" id="editIngQuantity" class="input" placeholder="æ•°é‡">
                    <select id="editIngUnit" class="select">
                        <option value="ä»½">ä»½</option>
                        <option value="è¢‹">è¢‹</option>
                        <option value="ç›’">ç›’</option>
                        <option value="ä¸ª">ä¸ª</option>
                        <option value="é¢—">é¢—</option>
                        <option value="g">g</option>
                        <option value="å—">å—</option>
                        <option value="æ ¹">æ ¹</option>
                        <option value="ç‰‡">ç‰‡</option>
                    </select>
                </div>
                <button id="addEditIngredient" class="btn btn-secondary" style="margin-bottom: 10px;">
                    â• æ·»åŠ é£Ÿæ
                </button>
                <div id="editIngredientsList"></div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancelEditBtn" class="btn btn-secondary">
                    âœ– å–æ¶ˆ
                </button>
                <button id="saveEditBtn" class="btn btn-success">
                    ğŸ’¾ ä¿å­˜ä¿®æ”¹
                </button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h3 style="margin-bottom: 15px; color: #ef4444; font-weight: 600;">ç¡®è®¤åˆ é™¤</h3>
            <p style="color: #6b7280; margin-bottom: 20px; line-height: 1.5;">
                ç¡®å®šè¦åˆ é™¤èœå“ "<span id="deleteDishName" style="font-weight: 600; color: #1f2937;"></span>" å—ï¼Ÿ
            </p>
            <p style="color: #ef4444; font-size: 0.9rem; margin-bottom: 20px;">
                âš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€
            </p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button id="cancelDeleteBtn" class="btn btn-secondary">
                    å–æ¶ˆ
                </button>
                <button id="confirmDeleteBtn" class="btn btn-danger">
                    ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>

    <script>dCx0w8C5y1/6KfKhGhAWAe0QGRV5qLGjYvVMdlrVdOlWTOo7E/F3K3E0K0o2qO2CHEJIv3sLGI8iA6X7hJNqVwfCeXbWPF1M0EyFlIfSJKVpLNLDQ2EQ+aNDEaNXqrwHCJvEhJ9pEE1EUNyHNOl7EftySqKMPvQJ1zovWmhWKNJzRKUw9o7KIKhtkE0yC3L4jQQxxvhZqPf8PTvWCDjlx1s8TkjOwpqN+n8K7vthZCX2cJEcwNBmtF7tP5uT1JTGVKTsrNZA8J8nh0EhIoJ0kcYWiTt1wYXsQ8r5U7NbN6P3gCCRk36VNc59XWNcOPT1iuEJYEyOoKwWJKFTcwbHNMAG5O6FMJISlXLaU7ygDL9YAcijHDp4gvKCYNP3KjyPWJrQIGBfmLsQK3QRNPl5lPO0R4U5Uf7WxjA4QlgQzBNKGLJ3fR+NF0WRjW8sRnOhJCbGgccG5q1o6CTfBIKy+PmhEX5LxhHg7IFBpnBJ6TKJd2HYDLUe0j9YZs2Lh43Q35iBgdJDmhCTKZjcvPmjhEEi8DfBnOg6r5BCFOLgHvIDhINagJGF7QFUCnThOsNx0/tUgUzEo5UgsLGGGsbyUCz1uTJvGKRrHnDgB+b3fFN2Rf5VqmI6JvAE8jz0ZLfhU3I0Zk5hLDdKJBsjdM4d4FoBa7GCBZaU/ItBTjEp6o6hFgn0DdgZd5V3bsaYTyOZGLMn7l/a9Ht0CaILrS0NfI7l4FWpfNaAFYP+RJB84kwP1wJoM6gZpKJp8lhCSTyEWfMKMPk8p+LJHu7U/vvMeJT7ioKZ0dYtjGGA/Xgf6RCbD1ghvFRQH1cOjD9KCtH0m57xfFBtFWFOLpHCL/cgQcIFqK6rKr7Q6tUhYjJ4zAsPL24G3g78s+5x0a7bFXJvJ+nTfD8TY5hgaJoEMn/Af4C/I1R3qhTBm1VIXaTcmCKRD3i7w8h+kP+bCw+CjgJHiCh2xo6TuL8lMDQOgpJE0pST0h5TaUIxnKnZjZDfpZA1xhOVNmJ/Xf8xNDj+AcPSRfN4gwCLybJfKLSdChgKYCDQKYPFmhBKaKB8fJWKaJBGVKNhJOhB4EhgzFGgvdyAQ8kTRIkXRqNNOCcJyOIigtNFnB+VFhIZE1Ol9KLvP34bZDJwLvt4FoZfAdJakmrT7TUCgQIQFQlkLV+YjFNKKj5gixeCiVWqo7S1KNlKAFbhd5eZo7kngWqT5MsOcOIIcj9yjNJhGD5VAjJpEMT7IgAe6QiawHXEH4kJoY6rOBwJMDUq9Pz+2gVqCgASJ7OQj1iC6F+1Z5G5FHqxXQLdHUNJKuoJEPVcKUVCNB4MkYN8rL6cTKtABmFtqAIcOJOkC3RpNnqTJRjhP0hNoY4VHdLJKVtE2jczthOnJJIrclEXUxjLF2Ks9xTdZYjhC0tIxgI7VD6mBR2lLWXrP6nJIGpYRPZfOjUyVt3CJ6nRKSt4nKJYm1xUL0QPUr2iYLv7eA/hzXBD5qNJfSdJdNMUZaKcJb0QAYeRK5TImJhGhp+0b3Cxz5v3bI4aCh4eVZNvhOcZoF2dP+WFgCCjL4U7lKQ2ZZtJ39Pc4jlnVJNDAl3SqCpOiLOLU3c8ohGiNsVCn6Ay5Tc7TI37BcXkL0QeCPyHeA14DXgfeAd4F3gbeAV4CXgOeBZ4APwOvID8wlnQJcQQCMOmJJTpXHFJPqS7mL1QCKKZ3JKFD7tMQ8AIKBFu5IeHZwmRhqQRGCaP0t8oBCpFc41A9xJI6vwtSQxmGKGzHpECd1YlOGcFHGvDM6Q4Ek1s6eYZLZ0FfpZKdCx0w8C5y1/6KfKhGhAWAe0QGRV5qLGjYvVMdlrVdOlWTOo7E/F3K3E0K0o2qO2CHEJIv3sLGI8iA6X7hJNqVwfCeXbWPF1M0EyFlIfSJKVpLNLDQ2EQ+aNDEaNXqrwHCJvEhJ9pEE1EUNyHNOl7EftySqKMPvQJ1zovWmhWKNJzRKUw9o7KIKhtkE0yC3L4jQQxxvhZqPf8PTvWCDjlx1s8TkjOwpqN+n8K7vthZCX2cJEcwNBmtF7tP5uT1JTGVKTsrNZA8J8nh0EhIoJ0kcYWiTt1wYXsQ8r5U7NbN6P3gCCRk36VNc59XWNcOPT1iuEJYEyOoKwWJKFTcwbHNMAG5O6FMJISlXLaU7ygDL9YAcijHDp4gvKCYNP3KjyPWJrQIGBfmLsQK3QRNPl5lPO0R4U5Uf7WxjA4QlgQzBNKGLJ3fR+NF0WRjW8sRnOhJCbGgccG5q1o6CTfBIKy+PmhEX5LxhHg7IFBpnBJ6TKJd2HYDLUe0j9YZs2Lh43Q35iBgdJDmhCTKZjcvPmjhEEi8DfBnOg6r5BCFOLgHvIDhINagJGF7QFUCnThOsNx0/tUgUzEo5UgsLGGGsbyUCz1uTJvGKRrHnDgB+b3fFN2Rf5VqmI6JvAE8jz0ZLfhU3I0Zk5hLDdKJBsjdM4d4FoBa7GCBZaU/ItBTjEp6o6hFgn0DdgZd5V3bsaYTyOZGLMn7l/a9Ht0CaILrS0NfI7l4FWpfNaAFYP+RJB84kwP1wJoM6gZpKJp8lhCSTyEWfMKMPk8p+LJHu7U/vvMeJT7ioKZ0dYtjGGA/Xgf6RCbD1ghvFRQH1cOjD9KCtH0m57xfFBtFWFOLpHCL/cgQcIFqK6rKr7Q6tUhYjJ4zAsPL24G3g78s+5x0a7bFXJvJ+nTfD8TY5hgaJoEMn/Af4C/I1R3qhTBm1VIXaTcmCKRD3i7w8h+kP+bCw+CjgJHiCh2xo6TuL8lMDQOgpJE0pST0h5TaUIxnKnZjZDfpZA1xhOVNmJ/Xf8xNDj+AcPSRfN4gwCLybJfKLSdChgKYCDQKYPFmhBKaKB8fJWKaJBGVKNhJOhB4EhgzFGgvdyAQ8kTRIkXRqNNOCcJyOIigtNFnB+VFhIZE1Ol9KLvP34bZDJwLvt4FoZfAdJakmrT7TUCgQIQFQlkLV+YjFNKKj5gixeCiVWqo7S1KNlKAFbhd5eZo7kngWqT5MsOcOIIcj9yjNJhGD5VAjJpEMT7IgAe6QiawHXEH4kJoY6rOBwJMDUq9Pz+2gVqCgASJ7OQj1iC6F+1Z5G5FHqxXQLdHUNJKuoJEPVcKUVCNB4MkYN8rL6cTKtABmFtqAIcOJOkC3RpNnqTJRjhP0hNoY4VHdLJKVtE2jczthOnJJIrclEXUxjLF2Ks9xTdZYjhC0tIxgI7VD6mBR2lLWXrP6nJIGpYRPZfOjUyVt3CJ6nRKSt4nKJYm1xUL0QPUr2iYLv7eA/hzXBD5qNJfSdJdNMUZaKcJb0QAYeRK5TImJhGhp+0b3Cxz5v3bI4aCh4eVZNvhOcZoF2dP+WFgCCjL4U7lKQ2ZZtJ39Pc4jlnVJNDAl3SqCpOiLOLU3c8ohGiNsVCn6Ay5Tc7TI37BcXkL0QeCPyHeA14DXgfeAd4F3gbeAV4CXgOeBZ4APwOvID8wlnQJcQQCMOmJJTpXHFJPqS7mL1QCKKZ3JKFD7tMQ8AIKBFu5IeHZwmRhqQRGCaP0t8oBCpFc41A9xJI6vwtSQxmGKGzHpECd1YlOGcFHGvDM6Q4Ek1s6eYZLZ0FfpZK
